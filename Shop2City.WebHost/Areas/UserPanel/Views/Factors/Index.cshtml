@using MadWin.Core.DTOs.Fators
@using MadWin.Core.DTOs.Orders
@using Shop2City.Core.Convertors
@using Shop2City.WebHost.ViewModels.Orders
@model FactorForAdminViewModel

@{
     var factor = Model.FactorSummary?.FirstOrDefault();
    var factorId = factor?.FactorId ?? 0;
    ViewBag.Title = "لیست فاکتورها";
    var currentFromDate = Context.Request.Query["FromDate"].ToString() ?? "";
    var currentToDate = Context.Request.Query["ToDate"].ToString() ?? "";
    var currentOrderId = Context.Request.Query["OrderId"].ToString() ?? "";
    var currentFromPrice = Context.Request.Query["FromPrice"].ToString() ?? "";
    var currentToPrice = Context.Request.Query["ToPrice"].ToString() ?? "";

    int visiblePages = 3;
    int startPage = Math.Max(Model.CurrentPage - visiblePages, 1);
    int endPage = Math.Min(Model.CurrentPage + visiblePages, Model.CountPage);
}

<div class="container-fluid mt-3">
    <div class="row g-3">

        <!--ستون سایدبار -->
        <partial name="_SideBar"/>

        <!--  ستون محتوای اصلی -->
        <main class="col-12 col-md-9">
            <!-- فیلتر -->
    <div class="card border-info shadow-sm mb-3">
                <div class="card-header bg-info text-white fs-5">فیلتر جستجو</div>
                <div class="card-body">
                    <form method="get">
                        <div class="row g-2">
                            <div class="col-12 col-md-3">
                                <label for="FromDate" class="form-label">از تاریخ:</label>
                                <input id="FromDate" name="FromDate" value="@currentFromDate"
                                       class="form-control" type="date" />
                            </div>
                            <div class="col-12 col-md-3">
                                <label for="ToDate" class="form-label">تا تاریخ:</label>
                                <input id="ToDate" name="ToDate" value="@currentToDate"
                                       class="form-control" type="date" />
                            </div>
                            <div class="col-12 col-md-3">
                                <label for="OrderId" class="form-label">کد سفارش:</label>
                                <input id="OrderId" name="OrderId" value="@currentOrderId"
                                       class="form-control" type="number" placeholder="کد سفارش" />
                            </div>
                            <div class="col-12 col-md-3">
                                <label for="FromPrice" class="form-label">از مبلغ:</label>
                                <input id="FromPrice" name="FromPrice" value="@currentFromPrice"
                                       class="form-control" type="number" placeholder="حداقل مبلغ" />
                            </div>
                            <div class="col-12 col-md-3">
                                <label for="ToPrice" class="form-label">تا مبلغ:</label>
                                <input id="ToPrice" name="ToPrice" value="@currentToPrice"
                                       class="form-control" type="number" placeholder="حداکثر مبلغ" />
                            </div>
                        </div>
                        <div class="mt-3 text-end">
                            <button type="submit" class="btn btn-primary w-100 w-md-auto">جستجو</button>
                        </div>
                    </form>
                </div>
            </div>


            <!-- کارت‌های فاکتور -->
            @if (Model.FactorSummary != null && Model.FactorSummary.Any())
            {
                <div class="container mt-4">
                    <h4 class="mb-3">لیست فاکتورها</h4>
                    <div class="row g-3">
                        @foreach (var item in Model.FactorSummary)
                        {
                            <div class="col-12 col-sm-6 col-lg-4 col-xl-4">
                                <div class="card factor-card h-100 shadow-sm @(item.IsFinaly ? "border-success" : "border-secondary")">
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title text-truncate">شماره فاکتور: @item.FactorId</h5>
                                        <p class="card-text mb-1"><i class="fas fa-calendar-alt"></i> @item.CreateDate.ToShamsi() - @item.CreateDate.ToString("HH:mm:ss")</p>
                                        <p class="card-text mb-1"><i class="fas fa-box"></i> @item.FactorDetailItemCount آیتم</p>
                                        <p class="card-text mb-1"><i class="fas fa-tag"></i> @item.DisTotal.ToString("N0") ریال (@item.DisPercent%)</p>
                                        <p class="card-text mb-1"><i class="fas fa-coins"></i> @item.FinalTotal.ToString("N0") تومان</p>
                                        <p class="card-text mb-2">
                                            <strong>وضعیت:</strong>
                                            <span class="@(item.IsFinaly ? "status-paid" : "status-unpaid")">
                                                @(item.IsFinaly ? "تسویه شد" : "تسویه نشده")
                                            </span>
                                        </p>
                                        <div class="mt-auto">
                                            <button class="btn btn-outline-primary w-100" onclick="showFactorDetails(@item.FactorId)">
                                                <i class="fas fa-eye"></i> مشاهده
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- صفحه‌بندی -->
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination pagination-sm justify-content-center flex-wrap">
                            <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                                <a class="page-link" href="@Url.Action("Index", "Factors", new {
                                    area = "Admin",
                                    pageId = Model.CurrentPage - 1,
                                    FromDate = currentFromDate,
                                    ToDate = currentToDate,
                                    OrderId = currentOrderId,
                                    FromPrice = currentFromPrice,
                                    ToPrice = currentToPrice
                                })">قبل</a>
                            </li>

                            @for (var i = startPage; i <= endPage; i++)
                            {
                                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                    <a class="page-link" href="@Url.Action("Index", "Factors", new {
                                        area = "Admin",
                                        pageId = i,
                                        FromDate = currentFromDate,
                                        ToDate = currentToDate,
                                        OrderId = currentOrderId,
                                        FromPrice = currentFromPrice,
                                        ToPrice = currentToPrice
                                    })">@i</a>
                                </li>
                            }

                            <li class="page-item @(Model.CurrentPage == Model.CountPage ? "disabled" : "")">
                                <a class="page-link" href="@Url.Action("Index", "Factors", new {
                                    area = "Admin",
                                    pageId = Model.CurrentPage + 1,
                                    FromDate = currentFromDate,
                                    ToDate = currentToDate,
                                    OrderId = currentOrderId,
                                    FromPrice = currentFromPrice,
                                    ToPrice = currentToPrice
                                })">بعد</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            }
            else
            {
                <div class="alert alert-warning mt-4 text-center">هیچ سفارشی یافت نشد.</div>
            }

            <!-- لودر -->
            <div id="factorDetailsLoader" class="d-flex justify-content-center my-3" style="display: none;">
            </div>
        </main>
    </div>
</div>
<!-- Modal جزئیات فاکتور -->
<div class="modal fade" id="factorDetailsModal" tabindex="-1" aria-labelledby="factorDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="factorDetailsModalLabel">جزئیات فاکتور @factorId </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="factorDetailsContent">
                <!-- محتوای فاکتور بارگذاری می‌شود -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
                $(document).ready(function () {
              $('#FromDate').persianDatepicker(
                  {
                      observer: true,
                      format: 'YYYY/MM/DD',
                      Datepicker: '#FromDate',
                      autoClose: true,
                      minDate: new persianDate().unix()

                  });
              $('#ToDate').persianDatepicker(
                  {
                      observer: true,
                      format: 'YYYY/MM/DD',
                      Datepicker: '#ToDate',
                      autoClose: true
                  });

          });
        function showFactorDetails(factorId) {
            // نمایش لودر
            document.getElementById("factorDetailsLoader").style.display = "block";
            document.getElementById("factorDetailsContent").innerHTML = "";

            fetch('/Admin/Factors/ShowFactorDetails?id=' + factorId)
                .then(response => response.text())
                .then(html => {
                    document.getElementById("factorDetailsLoader").style.display = "none";
                    document.getElementById("factorDetailsContent").innerHTML = html;
                    var myModal = new bootstrap.Modal(document.getElementById('factorDetailsModal'));
                    myModal.show();
                })
                .catch(error => {
                    document.getElementById("factorDetailsContent").innerHTML = "خطا در بارگذاری اطلاعات";
                    console.error(error);
                });
        }
    </script>
}
