@using MadWin.Core.DTOs.Orders
@using Shop2City.Core.Convertors
@using Shop2City.WebHost.ViewModels.Orders
@model OrderForAdminViewModel

@{
    ViewBag.Title = "لیست سفارش ها";
    var currentFromDate = (Context.Request.Query["FromDate"].ToString() ?? "");
    var currentToDate = (Context.Request.Query["ToDate"].ToString() ?? "");
    var currentOrderId = (Context.Request.Query["OrderId"].ToString() ?? "");
    var currentFromPrice = (Context.Request.Query["FromPrice"].ToString() ?? "");
    var currentToPrice = (Context.Request.Query["ToPrice"].ToString() ?? "");
    
    int visiblePages = 3; // تعداد صفحات قبل و بعد از صفحه فعلی
    int startPage = Math.Max(Model.CurrentPage - visiblePages, 1);
    int endPage = Math.Min(Model.CurrentPage + visiblePages, Model.CountPage);
}
<div class="container-fluid mt-3">
  <div class="row">
      <partial name="_SideBar" />
    <!-- محتوای اصلی -->
    <main class="col-12 col-lg-9">
      <!-- فیلتر -->
      <div class="card border-info shadow-sm mb-3">
        <div class="card-header bg-info text-white fs-5">فیلتر جستجو</div>
        <div class="card-body">
          <form method="get">
            <div class="row g-3">
              <div class="col-12 col-md-3">
                <label for="FromDate" class="form-label">از تاریخ:</label>
                <input id="FromDate" name="FromDate" value="@currentFromDate" class="form-control" type="date" />
              </div>
              <div class="col-12 col-md-3">
                <label for="ToDate" class="form-label">تا تاریخ:</label>
                <input id="ToDate" name="ToDate" value="@currentToDate" class="form-control" type="date" />
              </div>
              <div class="col-12 col-md-3">
                <label for="OrderId" class="form-label">کد سفارش:</label>
                <input id="OrderId" name="OrderId" value="@currentOrderId" class="form-control" type="number" placeholder="کد سفارش" />
              </div>
              <div class="col-12 col-md-3">
                <label for="FromPrice" class="form-label">از مبلغ:</label>
                <input id="FromPrice" name="FromPrice" value="@currentFromPrice" class="form-control" type="number" placeholder="حداقل مبلغ" />
              </div>
              <div class="col-12 col-md-3">
                <label for="ToPrice" class="form-label">تا مبلغ:</label>
                <input id="ToPrice" name="ToPrice" value="@currentToPrice" class="form-control" type="number" placeholder="حداکثر مبلغ" />
              </div>
            </div>
            <div class="mt-3 text-end">
              <button type="submit" class="btn btn-primary w-100 w-md-auto">جستجو</button>
            </div>
          </form>
        </div>
      </div>

      <!-- بخش لیست سفارش‌ها -->
      @if (Model.OrderSummary != null && Model.OrderSummary.Any())
      {
        <div class="container mt-4">
          <h4 class="mb-3">لیست سفارش‌ها</h4>
          <div class="row g-3">
            @foreach (var item in Model.OrderSummary)
            {
              <div class="col-sm-6 col-lg-4 col-xl-4">
                <div class="card h-100 shadow-sm @(item.IsFinaly ? "border-success" : "border-secondary")">
                  <div class="card-body">
                            <h5 class="card-title">کد سفارش: @item.OrderId</h5>
                            <p class="card-text"><strong>تاریخ:</strong> @item.CreateDate.ToShamsi() - @item.CreateDate.ToString("HH:mm:ss")</p>
                            <p class="card-text"><strong>نوع:</strong> @item.CategoryGroup</p>
                            <p class="card-text"><strong>ابعاد:</strong> @item.Size</p>
                            <p class="card-text"><strong>تعداد:</strong> @item.Count</p>

                            @if (item.WidthParts != null && item.WidthParts.Any())
                            {
                                <p class="card-text">
                                    <strong>تکه‌ها:</strong> @(item.IsEqualParts ? "قطعات مساوی هستند" : "قطعات اندازه‌های مختلف دارند")
                                </p>
                                <p class="card-text">
                                    <strong>موقعیت قطعات:</strong>
                                    @for (int i = 0; i < item.WidthParts.Count; i++)
                                    {
                                        string position = item.WidthParts.Count == 3
                                        ? (i == 0 ? "چپ" : i == 1 ? "وسط" : "راست")
                                        : (i % 2 == 0 ? "راست" : "چپ");
                                        <strong>@position:</strong> 
                                        @item.WidthParts[i].WidthValue
                                    }
                                </p>
                            }
                            <p class="card-text"><strong>میزان تخفیف:</strong> @item.DisTotal.ToString("N0") ریال (@item.DisPercent%)</p>
                            <p class="card-text"><strong>قیمت کل:</strong> @item.TotalPrice.ToString("N0") ریال</p>
                            <p class="card-text">
                                <strong>وضعیت:</strong>
                                @if (item.IsFinaly)
                                {
                                    <span class="text-success">تسویه شد</span>
                                }
                                else
                                {
                                    <span class="text-danger">تسویه نشده</span>
                                }
                            </p>
                        </div>
                </div>
              </div>
            }
          </div>

          <!-- صفحه‌بندی -->
          <nav aria-label="Page navigation" class="mt-3">
            <ul class="pagination pagination-sm flex-wrap justify-content-center">
              <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                <a class="page-link" href="@Url.Action("Index", "Orders", new {
                  area = "Admin",
                  pageId = Model.CurrentPage - 1,
                  FromDate = currentFromDate,
                  ToDate = currentToDate,
                  OrderId = currentOrderId,
                  FromPrice = currentFromPrice,
                  ToPrice = currentToPrice
                })">قبل</a>
              </li>

              @for (var i = startPage; i <= endPage; i++)
              {
                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                  <a class="page-link" href="@Url.Action("Index", "Orders", new {
                    area = "Admin",
                    pageId = i,
                    FromDate = currentFromDate,
                    ToDate = currentToDate,
                    OrderId = currentOrderId,
                    FromPrice = currentFromPrice,
                    ToPrice = currentToPrice
                  })">@i</a>
                </li>
              }

              <li class="page-item @(Model.CurrentPage == Model.CountPage ? "disabled" : "")">
                <a class="page-link" href="@Url.Action("Index", "Orders", new {
                  area = "Admin",
                  pageId = Model.CurrentPage + 1,
                  FromDate = currentFromDate,
                  ToDate = currentToDate,
                  OrderId = currentOrderId,
                  FromPrice = currentFromPrice,
                  ToPrice = currentToPrice
                })">بعد</a>
              </li>
            </ul>
          </nav>
        </div>
      }
      else
      {
        <div class="alert alert-warning mt-4 text-center">هیچ سفارشی یافت نشد.</div>
      }
    </main>
  </div>
</div>
