@using MadWin.Core.DTOs.Orders
@using Shop2City.Core.Convertors
@using Shop2City.WebHost.ViewModels.Orders
@model OrderForAdminViewModel

@{
    ViewBag.Title = "لیست سفارش ها";
    var currentFromDate = (Context.Request.Query["FromDate"].ToString() ?? "");
    var currentToDate = (Context.Request.Query["ToDate"].ToString() ?? "");
    var currentOrderId = (Context.Request.Query["OrderId"].ToString() ?? "");
    var currentFromPrice = (Context.Request.Query["FromPrice"].ToString() ?? "");
    var currentToPrice = (Context.Request.Query["ToPrice"].ToString() ?? "");
    
    int visiblePages = 3; // تعداد صفحات قبل و بعد از صفحه فعلی
    int startPage = Math.Max(Model.CurrentPage - visiblePages, 1);
    int endPage = Math.Min(Model.CurrentPage + visiblePages, Model.CountPage);
}
<!-- فیلتر جستجو -->
<div class="container mt-3">
    <div class="card border-info shadow-sm">
        <div class="card-header bg-info text-white fs-5">فیلتر جستجو</div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="FromDate" class="form-label">از تاریخ:</label>
                    <input type="text" id="FromDate" name="FromDate" value="@currentFromDate" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label for="ToDate" class="form-label">تا تاریخ:</label>
                    <input type="text" id="ToDate" name="ToDate" value="@currentToDate" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label for="OrderId" class="form-label">کد سفارش:</label>
                    <input type="number" id="OrderId" name="OrderId" value="@currentOrderId" class="form-control" placeholder="کد سفارش" />
                </div>
                <div class="col-md-3">
                    <label for="FromPrice" class="form-label">از مبلغ:</label>
                    <input type="number" id="FromPrice" name="FromPrice" value="@currentFromPrice" class="form-control" placeholder="حداقل مبلغ" />
                </div>
                <div class="col-md-3">
                    <label for="ToPrice" class="form-label">تا مبلغ:</label>
                    <input type="number" id="ToPrice" name="ToPrice" value="@currentToPrice" class="form-control" placeholder="حداکثر مبلغ" />
                </div>
                <div class="col-12 text-end">
                    <button type="submit" class="btn btn-primary">جستجو</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- لیست سفارش‌ها -->@if (Model.OrderSummary != null && Model.OrderSummary.Any())
{
    <div class="container mt-4">
        <h4 class="mb-4 fw-bold text-center">لیست سفارش‌ها</h4>

        <div class="row g-4">
            @foreach (var item in Model.OrderSummary)
            {
                <div class="col-md-4">
                    <div class="card h-100 shadow-lg border-0 rounded-3 order-card">

                        <div class="card-header text-white
                                    @(item.IsFinaly ? "bg-success" : "bg-secondary") rounded-top">
                            <h5 class="mb-0">کد سفارش:@item.OrderId</h5>
                        </div>

                        <div class="card-body">
                            <p class="text-muted small">@item.CreateDate.ToShamsi() - @item.CreateDate.ToString("HH:mm")</p>

                            <p>
                                <strong>نوع:</strong> @item.CategoryGroup
                                @if (item.IsCurtainAdhesive)
                                {
                                    <span class="badge bg-success ms-1">چسب بغل کامل</span>
                                }
                            </p>

                            <p><strong>ابعاد:</strong> @item.Size</p>
                            <p><strong>تعداد:</strong> @item.Count</p>

                            @if (item.WidthParts != null && item.WidthParts.Any())
                            {
                                <div class="mb-2">
                                    <strong>تکه‌ها:</strong>
                                    <span class="badge bg-info text-dark">
                                        @(item.IsEqualParts ? "قطعات مساوی" : "قطعات متفاوت")
                                    </span>
                                </div>

                                <div class="small bg-light p-2 rounded">
                                    @for (int i = 0; i < item.WidthParts.Count; i++)
                                    {
                                        string position = item.WidthParts.Count == 3
                                        ? (i == 0 ? "چپ" : i == 1 ? "وسط" : "راست")
                                        : (i % 2 == 0 ? "راست" : "چپ");

                                        <div>
                                            <strong>@position:</strong> @item.WidthParts[i].WidthValue cm
                                        </div>
                                    }
                                </div>
                            }

                            <hr />

                            <p><strong>قیمت پایه:</strong> @item.BasePrice.ToString("N0") ریال</p>
                            <p><strong>تخفیف:</strong> @item.DisTotal.ToString("N0") ریال (@item.DisPercent%)</p>
                            <p class="fw-bold text-primary"><strong>قیمت کل:</strong> @item.TotalPrice.ToString("N0") ریال</p>

                            <p><strong>آدرس:</strong> @item.Address</p>
                            <p><strong>شیوه ارسال:</strong> @item.DeliveryMethodName (@item.DeliveryMethodCost.ToString("N0")ریال)</p>
                            <p><strong>توضیحات:</strong> @item.Description</p>
                            <p>
                                <strong>وضعیت:</strong>
                                @if (item.IsFinaly)
                                {
                                    <span class="text-success fw-bold">تسویه شده</span>
                                }
                                else
                                {
                                    <span class="text-danger fw-bold">تسویه نشده</span>
                                }
                            </p>

                        </div>
                    </div>
                </div>

            }
        </div>

        <!-- صفحه‌بندی -->
        <nav class="mt-5">
            <ul class="pagination justify-content-center">
                <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("Index", "Orders", new { area = "UserPanel", pageId = Model.CurrentPage - 1 })">قبلی</a>
                </li>

                @for (var i = startPage; i <= endPage; i++)
                {
                    <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                        <a class="page-link" href="@Url.Action("Index", "Orders", new { area = "UserPanel", pageId = i })">@i</a>
                    </li>
                }

                <li class="page-item @(Model.CurrentPage == Model.CountPage ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("Index", "Orders", new { area = "UserPanel", pageId = Model.CurrentPage + 1 })">بعدی</a>
                </li>
            </ul>
        </nav>
    </div>
}
else
{
    <div class="alert alert-warning text-center mt-5 p-4 fs-5 rounded-3 shadow-sm">
        هیچ سفارشی یافت نشد.
    </div>
}

@section Scripts {
    <script src="~/js/datepicker/datepicker-config.js"></script>
}


