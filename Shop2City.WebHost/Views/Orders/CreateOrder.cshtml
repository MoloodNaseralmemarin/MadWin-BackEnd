
@using Shop2City.WebHost.ViewModels.Orders
@model OrderViewModel
@{
    ViewData["Title"] = "ثبت سفارش جدید با اندازه دلخواه";
}

<div class="container my-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a asp-controller="Home" asp-action="Index"><i class="fa fa-home"></i></a>
            </li>
            <li class="breadcrumb-item">
                <a asp-area="UserPanel" asp-controller="Home" asp-action="Index">پنل کاربری</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">سفارش با اندازه دلخواه</li>
        </ol>
    </nav>

    <div class="row">
        <partial name="_SideBar" />
        <div class="col-lg-9">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#customSizeModal">
                سفارش با اندازه دلخواه
            </button>

            @await Component.InvokeAsync("OrderSummaryComponent", new { userId = Model.UserId })
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="customSizeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">سفارش با اندازه دلخواه</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
            </div>

            <div class="modal-body">
                <form asp-action="CreateOrder" method="post" id="customSizeForm" novalidate>

                    <input type="hidden" asp-for="PartCount" />
                    <input type="hidden" asp-for="IsEqualParts" />
                    <input type="hidden" asp-for="DivisionType" />

                    <!-- دسته و زیر دسته -->
                    <div class="row">
                        <div class="col-12 col-md-6 mb-2">
                            <label asp-for="CategoryId" class="form-label"></label>
                            <select asp-for="CategoryId" id="CategoryId" class="form-select" required>
                                <option value="">انتخاب کنید</option>
                                @foreach (var it in Model.Categories)
                                {
                                    <option value="@it.Value">@it.Text</option>
                                }
                            </select>
                            <div class="invalid-feedback">لطفا دسته را انتخاب کنید.</div>
                        </div>

                        <div class="col-12 col-md-6 mb-2">
                            <label asp-for="SubCategoryId" class="form-label"></label>
                            <select asp-for="SubCategoryId" id="SubCategoryId" class="form-select" required disabled>
                                <option value="">ابتدا دسته را انتخاب کنید</option>
                            </select>
                            <div class="invalid-feedback">لطفا زیر دسته را انتخاب کنید.</div>
                        </div>
                    </div>

                    <!-- هشدار -->
                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-info" role="alert">
                                مشتری گرامی، لطفاً جهت چپ و راست پرده را از محل نصب (نقطه چسباندن) تعیین کنید.
                            </div>
                        </div>
                    </div>

                    <!-- ارتفاع و عرض -->
                    <div class="row">
                        <div class="col-12 col-md-6 mb-2">
                            <label asp-for="Height" class="form-label"></label>
                            <input asp-for="Height" id="Height" class="form-control" required min="50" max="400" maxlength="3" />
                            <div class="invalid-feedback">ارتفاع باید بین ۵۰ تا ۴۰۰ باشد.</div>
                        </div>

                        <div class="col-12 col-md-6 mb-2">
                            <label asp-for="Width" class="form-label"></label>
                            <input asp-for="Width" id="Width" class="form-control" required min="50" max="400" maxlength="3" />
                            <div class="invalid-feedback">عرض باید بین ۵۰ تا ۴۰۰ باشد.</div>
                        </div>
                    </div>

                    <!-- چسب بغل پرده -->
                    <div class="mb-2">
                        <label class="form-label">چسب بغل پرده</label>
                        <div class="alert alert-light p-2 mb-2">لطفاً یکی از موارد را انتخاب کنید.</div>

                        <ul class="list-unstyled d-flex gap-2 flex-wrap">
                            <li>
                                <input class="btn-check" type="radio" name="IsCurtainAdhesive" id="adhesive-full" value="true">
                                <label class="btn btn-outline-primary" for="adhesive-full">کامل (سرتاسر ارتفاع پرده)</label>
                            </li>
                            <li>
                                <input class="btn-check" type="radio" name="IsCurtainAdhesive" id="adhesive-normal" value="false">
                                <label class="btn btn-outline-primary" for="adhesive-normal">معمولی (هر 40 تا 50 سانتی‌متر 10 سانتی‌متر چسب)</label>
                            </li>
                        </ul>

                        <!-- پیام خطا برای چسب (الزامی برای رفع خطای null) -->
                        <div id="adhesive-error" class="invalid-feedback d-none">لطفا نوع چسب بغل پرده را انتخاب کنید.</div>
                    </div>

                    <!-- تقسیم‌بندی -->
                    <div class="mb-2">
                        <label class="form-label">تقسیم‌بندی</label>
                        <div class="alert alert-light p-2 mb-2">لطفاً یکی از موارد را انتخاب کنید.</div>
                        <ul id="divisionList" class="list-unstyled d-flex gap-2 flex-wrap">
                            <li>
                                <input class="btn-check" type="radio" name="division" id="div-2-equal" value="2-equal" onclick="updateInputs(2,'equal')">
                                <label class="btn btn-outline-primary" for="div-2-equal">۲ مساوی</label>
                            </li>

                            <li>
                                <input class="btn-check" type="radio" name="division" id="div-2-unequal" value="2-unequal" onclick="updateInputs(2,'unequal')">
                                <label class="btn btn-outline-primary" for="div-2-unequal">۲ نامساوی</label>
                            </li>

                            <li>
                                <input class="btn-check" type="radio" name="division" id="div-3-equal" value="3-equal" onclick="updateInputs(3,'equal')">
                                <label class="btn btn-outline-primary" for="div-3-equal">۳ مساوی</label>
                            </li>

                            <li>
                                <input class="btn-check" type="radio" name="division" id="div-3-unequal" value="3-unequal" onclick="updateInputs(3,'unequal')">
                                <label class="btn btn-outline-primary" for="div-3-unequal">۳ نامساوی</label>
                            </li>
                        </ul>
                        <div class="invalid-feedback d-none" id="division-error">لطفا نوع تقسیم‌بندی را انتخاب کنید.</div>
                    </div>

                    <!-- بخش‌ها -->
                    <div id="width-inputs" style="display:none;">
                        <label class="form-label">اندازه بخش‌ها (cm)</label>
                        <div id="input-container"></div>
                        <div class="small text-danger width-error" style="display:none;">
                            مجموع قسمت‌ها باید برابر عرض کل باشد.
                        </div>
                    </div>

                    <!-- تعداد -->
                    <div class="mt-3">
                        <label asp-for="Count" class="form-label"></label>
                        <input asp-for="Count" id="Count" class="form-control" required min="1" />
                        <div class="invalid-feedback count-error">لطفا تعداد را بین ۱ تا ۲۰۰ وارد کنید.</div>
                    </div>

                    <div class="mt-3">
                        <button type="submit" id="submitBtn" class="btn btn-primary w-100" disabled>ثبت سفارش</button>
                    </div>

                </form>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
<<<<<<< HEAD
            // المان‌ها
            const form = document.getElementById('customSizeForm');
            const submitBtn = document.getElementById('submitBtn');
            const widthInput = document.getElementById('Width');
            const heightInput = document.getElementById('Height');
            const countInput = document.getElementById('Count');
            const countErrorEl = form ? form.querySelector('.count-error') : null;
            const inputContainer = document.getElementById('input-container');
            const widthInputsWrapper = document.getElementById('width-inputs');
            const widthErrorEl = document.querySelector('.width-error');
            const categoryEl = document.getElementById('CategoryId');
            const subSelect = document.getElementById('SubCategoryId');
            const divisionErrorEl = document.getElementById('division-error');
            const adhesiveError = document.getElementById('adhesive-error');

            // helper
            function safeToggleClass(el, className, add) {
                if (!el) return;
                if (add) el.classList.add(className);
                else el.classList.remove(className);
=======
          // المان‌ها
          const form = document.getElementById('customSizeForm');
          const submitBtn = document.getElementById('submitBtn');
          const widthInput = document.getElementById('Width');
          const heightInput = document.getElementById('Height');
          const countInput = document.getElementById('Count');
          const countErrorEl = form ? form.querySelector('.count-error') : null;
          const inputContainer = document.getElementById('input-container');
          const widthInputsWrapper = document.getElementById('width-inputs');
          const widthErrorEl = document.querySelector('.width-error');
          const categoryEl = document.getElementById('CategoryId');
          const subSelect = document.getElementById('SubCategoryId');
          const divisionErrorEl = document.getElementById('division-error');
          const adhesiveError = document.getElementById('adhesive-error');

          // helper ایمن برای تغییر کلاس
          function safeToggleClass(el, className, add) {
            if (!el) return;
            if (add) el.classList.add(className);
            else el.classList.remove(className);
          }

          function qAll(selector, ctx = document) {
            return Array.from((ctx || document).querySelectorAll(selector));
          }

          function showInvalid(el, msg) {
            if (!el) return;
            el.classList.add('is-invalid');
            let fb = el.parentNode.querySelector('.invalid-feedback');
            if (!fb) {
              fb = document.createElement('div');
              fb.className = 'invalid-feedback';
              el.parentNode.appendChild(fb);
>>>>>>> f99be209bd00a959536bd2503c41a4c308b467b4
            }

<<<<<<< HEAD
            function qAll(selector, ctx = document) {
                return Array.from((ctx || document).querySelectorAll(selector));
            }

            function showInvalid(el, msg) {
                if (!el) return;
                el.classList.add('is-invalid');
                let fb = el.parentNode.querySelector('.invalid-feedback');
                if (!fb) {
                    fb = document.createElement('div');
                    fb.className = 'invalid-feedback';
                    el.parentNode.appendChild(fb);
                }
                fb.textContent = msg;
            }

            function hideInvalid(el) {
                if (!el) return;
                el.classList.remove('is-invalid');
                const fb = el.parentNode.querySelector('.invalid-feedback');
                if (fb) fb.textContent = '';
            }

            // hint هنگام فوکوس
            [heightInput, widthInput].forEach(input => {
                if (!input) return;
                input.addEventListener('focus', () => {
                    let hint = input.parentNode.querySelector('.hint-feedback');
                    if (!hint) {
                        hint = document.createElement('div');
                        hint.className = 'hint-feedback text-primary small mt-1';
                        hint.textContent = 'مقدار باید بین ۵۰ تا ۴۰۰ سانتی‌متر باشد.';
                        input.parentNode.appendChild(hint);
                    }
                });
                input.addEventListener('blur', () => {
                    const hint = input.parentNode.querySelector('.hint-feedback');
                    if (hint) hint.remove();
                });
=======
          function hideInvalid(el) {
            if (!el) return;
            el.classList.remove('is-invalid');
            const fb = el.parentNode.querySelector('.invalid-feedback');
            if (fb) fb.textContent = '';
          }

          // hint هنگام فوکوس
          [heightInput, widthInput].forEach(input => {
            if (!input) return;
            input.addEventListener('focus', () => {
              let hint = input.parentNode.querySelector('.hint-feedback');
              if (!hint) {
                hint = document.createElement('div');
                hint.className = 'hint-feedback text-primary small mt-1';
                hint.textContent = 'مقدار باید بین ۵۰ تا ۴۰۰ سانتی‌متر باشد.';
                input.parentNode.appendChild(hint);
              }
>>>>>>> f99be209bd00a959536bd2503c41a4c308b467b4
            });

<<<<<<< HEAD
            function validateForm() {
                let valid = true;

                // چک فیلدهای پایه
                const fields = [
                    { el: categoryEl, msg: 'لطفا دسته را انتخاب کنید.' },
                    { el: subSelect, msg: 'لطفا زیر دسته را انتخاب کنید.' },
                    { el: heightInput, msg: 'ارتفاع باید بین ۵۰ تا ۴۰۰ باشد.' },
                    { el: widthInput, msg: 'عرض باید بین ۵۰ تا ۴۰۰ باشد.' }
                ];

                fields.forEach(f => {
                    if (!f.el || !f.el.value || String(f.el.value).trim() === '') {
                        valid = false;
                        showInvalid(f.el, f.msg);
                    } else {
                        if (f.el === heightInput || f.el === widthInput) {
                            const val = Number(f.el.value);
                            if (isNaN(val) || val < 50 || val > 400) {
                                valid = false;
                                showInvalid(f.el, f.msg);
                            } else hideInvalid(f.el);
                        } else hideInvalid(f.el);
                    }
                });

                // validate adhesive
                const adhesiveChecked = form ? form.querySelector('input[name="IsCurtainAdhesive"]:checked') : null;
                if (!adhesiveChecked) {
                    valid = false;
                    if (adhesiveError) safeToggleClass(adhesiveError, 'd-none', false);
                } else {
                    if (adhesiveError) safeToggleClass(adhesiveError, 'd-none', true);
                }

                // division selection
                const divChecked = form ? form.querySelector('input[name="division"]:checked') : null;
                if (!divChecked) {
                    valid = false;
                    if (divisionErrorEl) divisionErrorEl.classList.remove('d-none');
=======
          function validateForm() {
            let valid = true;

            // چک فیلدهای پایه
            const fields = [
              { el: categoryEl, msg: 'لطفا دسته را انتخاب کنید.' },
              { el: subSelect, msg: 'لطفا زیر دسته را انتخاب کنید.' },
              { el: heightInput, msg: 'ارتفاع باید بین ۵۰ تا ۴۰۰ باشد.' },
              { el: widthInput, msg: 'عرض باید بین ۵۰ تا ۴۰۰ باشد.' }
            ];

            fields.forEach(f => {
              if (!f.el || !f.el.value || String(f.el.value).trim() === '') {
                valid = false;
                showInvalid(f.el, f.msg);
              } else {
                if (f.el === heightInput || f.el === widthInput) {
                  const val = Number(f.el.value);
                  if (isNaN(val) || val < 50 || val > 400) {
                    valid = false;
                    showInvalid(f.el, f.msg);
                  } else hideInvalid(f.el);
                } else hideInvalid(f.el);
              }
            });

            // validate adhesive (ایمن)
            const adhesiveChecked = form ? form.querySelector('input[name="IsCurtainAdhesive"]:checked') : null;
            if (!adhesiveChecked) {
              valid = false;
              if (adhesiveError) safeToggleClass(adhesiveError, 'd-none', false); // remove d-none
            } else {
              if (adhesiveError) safeToggleClass(adhesiveError, 'd-none', true); // add d-none
            }

            // division selection
            const divChecked = form ? form.querySelector('input[name="division"]:checked') : null;
            if (!divChecked) {
              valid = false;
              if (divisionErrorEl) divisionErrorEl.classList.remove('d-none');
            } else {
              if (divisionErrorEl) divisionErrorEl.classList.add('d-none');
            }

            // count validation
            const cnt = parseInt(countInput ? countInput.value : '', 10);
            if (!countInput || !countInput.value || isNaN(cnt) || cnt < 1 || cnt > 200) {
              valid = false;
              if (countInput) showInvalid(countInput, 'لطفا تعداد را بین ۱ تا ۲۰۰ وارد کنید.');
              if (countErrorEl) countErrorEl.style.display = 'block';
            } else {
              if (countInput) hideInvalid(countInput);
              if (countErrorEl) countErrorEl.style.display = 'none';
            }

            // width parts sum
            const partEls = inputContainer ? qAll('.width-input', inputContainer) : [];
            if (partEls.length) {
              const total = Number(widthInput ? widthInput.value : 0) || 0;
              let sum = 0;
              let zeroOrEmpty = false;

              partEls.forEach(pe => {
                const val = Number(pe.value);
                if (!val || val <= 0) {
                  zeroOrEmpty = true;
                  pe.classList.add('is-invalid');
>>>>>>> f99be209bd00a959536bd2503c41a4c308b467b4
                } else {
                    if (divisionErrorEl) divisionErrorEl.classList.add('d-none');
                }

<<<<<<< HEAD
                // count validation
                const cnt = parseInt(countInput ? countInput.value : '', 10);
                if (!countInput || !countInput.value || isNaN(cnt) || cnt < 1 || cnt > 200) {
                    valid = false;
                    if (countInput) showInvalid(countInput, 'لطفا تعداد را بین ۱ تا ۲۰۰ وارد کنید.');
                    if (countErrorEl) countErrorEl.style.display = 'block';
                } else {
                    if (countInput) hideInvalid(countInput);
                    if (countErrorEl) countErrorEl.style.display = 'none';
                }

                // width parts sum
                const partEls = inputContainer ? qAll('.width-input', inputContainer) : [];
                if (partEls.length) {
                    const total = Number(widthInput ? widthInput.value : 0) || 0;
                    let sum = 0;
                    let zeroOrEmpty = false;
                    partEls.forEach(pe => {
                        const val = Number(pe.value);
                        if (!val || val <= 0) {
                            zeroOrEmpty = true;
                            pe.classList.add('is-invalid');
                        } else {
                            pe.classList.remove('is-invalid');
                        }
                        sum += val;
=======
              if (zeroOrEmpty || Math.round(sum) !== Math.round(total)) {
                valid = false;
                if (widthErrorEl) widthErrorEl.style.display = 'block';
              } else {
                if (widthErrorEl) widthErrorEl.style.display = 'none';
              }
            }

            if (submitBtn) submitBtn.disabled = !valid;
            return valid;
          }

          // load subcategories (ایمن)
          if (categoryEl) {
            categoryEl.addEventListener('change', function () {
              const catId = this.value;
              if (!subSelect) return;
              subSelect.innerHTML = '<option value="">در حال بارگذاری...</option>';
              subSelect.disabled = true;

              if (!catId) {
                subSelect.innerHTML = '<option value="">ابتدا دسته را انتخاب کنید</option>';
                subSelect.disabled = true;
                validateForm();
                return;
              }

              const url = '@Url.Action("GetSubCategories", "Orders")' + '?categoryId=' + encodeURIComponent(catId);
              fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(r => r.json())
                .then(data => {
                  const items = Array.isArray(data) ? data : data.items ?? data;
                  subSelect.innerHTML = '<option value="">انتخاب کنید</option>';

                  if (!items?.length) {
                    subSelect.innerHTML = '<option value="">زیر دسته‌ای موجود نیست</option>';
                    subSelect.disabled = true;
                  } else {
                    items.forEach(item => {
                      const opt = document.createElement('option');
                      opt.value = item.value ?? item.id ?? item.Value ?? item.Id ?? '';
                      opt.textContent = item.text ?? item.name ?? item.Text ?? item.Name ?? opt.value;
                      subSelect.appendChild(opt);
>>>>>>> f99be209bd00a959536bd2503c41a4c308b467b4
                    });
                    if (zeroOrEmpty || Math.round(sum) !== Math.round(total)) {
                        valid = false;
                        if (widthErrorEl) widthErrorEl.style.display = 'block';
                    } else {
                        if (widthErrorEl) widthErrorEl.style.display = 'none';
                    }
                }

                if (submitBtn) submitBtn.disabled = !valid;
                return valid;
            }

            // load subcategories
            if (categoryEl) {
                categoryEl.addEventListener('change', function () {
                    const catId = this.value;
                    if (!subSelect) return;
                    subSelect.innerHTML = '<option value="">در حال بارگذاری...</option>';
                    subSelect.disabled = true;
                    if (!catId) {
                        subSelect.innerHTML = '<option value="">ابتدا دسته را انتخاب کنید</option>';
                        subSelect.disabled = true;
                        validateForm();
                        return;
                    }
                    const url = '@Url.Action("GetSubCategories", "Orders")' + '?categoryId=' + encodeURIComponent(catId);
                    fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                        .then(r => r.json())
                        .then(data => {
                            const items = Array.isArray(data) ? data : data.items ?? data;
                            subSelect.innerHTML = '<option value="">انتخاب کنید</option>';
                            if (!items?.length) {
                                subSelect.innerHTML = '<option value="">زیر دسته‌ای موجود نیست</option>';
                                subSelect.disabled = true;
                            } else {
                                items.forEach(item => {
                                    const opt = document.createElement('option');
                                    opt.value = item.value ?? item.id ?? item.Value ?? item.Id ?? '';
                                    opt.textContent = item.text ?? item.name ?? item.Text ?? item.Name ?? opt.value;
                                    subSelect.appendChild(opt);
                                });
                                subSelect.disabled = false;
                            }
                            validateForm();
                        })
                        .catch(() => {
                            subSelect.innerHTML = '<option value="">خطا در بارگذاری</option>';
                            subSelect.disabled = true;
                            validateForm();
                        });
                });
<<<<<<< HEAD
            }

            // updateInputs
            window.updateInputs = function (count, type) {
                const total = Number(widthInput ? widthInput.value : 0) || 0;

                // ذخیره تنظیمات تقسیم‌بندی در hidden
                if (form) {
                    const partCountInput = form.querySelector('[name="PartCount"]');
                    const isEqualInput = form.querySelector('[name="IsEqualParts"]');
                    const divisionTypeInput = form.querySelector('[name="DivisionType"]');
                    if (partCountInput) partCountInput.value = count;
                    if (isEqualInput) isEqualInput.value = (type === 'equal');
                    if (divisionTypeInput) divisionTypeInput.value = `${count}-${type}`;
                }

                // اگر عرض وارد نشده، فقط ذخیره کن و برگرد
                if (!total || total <= 0) {
                    if (widthInput) showInvalid(widthInput, 'لطفا ابتدا عرض کل را وارد کنید.');
                    validateForm();
                    return;
                }

                if (widthInput) hideInvalid(widthInput);

                if (!inputContainer || !widthInputsWrapper) return;
                inputContainer.innerHTML = '';
                widthInputsWrapper.style.display = 'block';

                const labels = (count === 2) ? ['راست', 'چپ'] : ['راست', 'وسط', 'چپ'];

                if (type === 'equal') {
                    const base = Math.floor(total / count);
                    const remainder = total - base * count;
                    for (let i = 0; i < count; i++) {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'mb-2';
                        const lbl = document.createElement('label');
                        lbl.className = 'form-label';
                        lbl.textContent = labels[i];
                        const inp = document.createElement('input');
                        inp.type = 'number';
                        inp.readOnly = true;
                        inp.className = 'form-control width-input';
                        inp.name = `WidthParts[${i}]`;
                        const extra = i < remainder ? 1 : 0;
                        inp.value = base + extra;
                        wrapper.appendChild(lbl);
                        wrapper.appendChild(inp);
                        inputContainer.appendChild(wrapper);
                    }
                } else {
                    for (let i = 0; i < count; i++) {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'mb-2';
                        const lbl = document.createElement('label');
                        lbl.className = 'form-label';
                        lbl.textContent = labels[i];
                        const inp = document.createElement('input');
                        inp.type = 'number';
                        inp.className = 'form-control width-input';
                        inp.name = `WidthParts[${i}]`;
                        inp.min = 1;
                        inp.required = true;
                        wrapper.appendChild(lbl);
                        wrapper.appendChild(inp);
                        inputContainer.appendChild(wrapper);
                    }
                }

                validateForm();
            };

            // وقتی عرض تغییر می‌کند و تقسیم انتخاب شده از قبل بوده، بروزرسانی کن
            if (widthInput) {
                widthInput.addEventListener('input', () => {
                    const checked = form ? form.querySelector('input[name="division"]:checked') : null;
                    if (!checked) return validateForm();
                    const [cntStr, type] = checked.value.split('-');
                    const count = Number(cntStr);
                    updateInputs(count, type);
                });
            }

            if (inputContainer) inputContainer.addEventListener('input', () => validateForm());

            // modal reset
            const modalEl = document.getElementById('customSizeModal');
            if (modalEl) {
                modalEl.addEventListener('shown.bs.modal', () => {
                    if (form) form.reset();
                    document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                    if (inputContainer) inputContainer.innerHTML = '';
                    if (widthInputsWrapper) widthInputsWrapper.style.display = 'none';
                    if (widthErrorEl) widthErrorEl.style.display = 'none';
                    if (divisionErrorEl) divisionErrorEl.classList.add('d-none');
                    if (adhesiveError) adhesiveError.classList.add('d-none');
                    if (countErrorEl) countErrorEl.style.display = 'none';
                    if (submitBtn) submitBtn.disabled = true;
                });
            }

            // submit و input handling
            if (form) {
                form.addEventListener('submit', e => {
                    if (!validateForm()) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
                form.addEventListener('input', validateForm);
            }

            // initial validation
            validateForm();
=======
            });
          }

          // updateInputs (ایجاد یا بروزرسانی فیلدهای بخش‌ها)
          window.updateInputs = function (count, type) {
            const total = Number(widthInput ? widthInput.value : 0) || 0;
            if (!total || total <= 0) {
              if (widthInput) showInvalid(widthInput, 'لطفا ابتدا عرض کل را وارد کنید.');
              validateForm();
              return;
            }

            if (form) {
              const partCountInput = form.querySelector('[name="PartCount"]');
              const isEqualInput = form.querySelector('[name="IsEqualParts"]');
              const divisionTypeInput = form.querySelector('[name="DivisionType"]');
              if (partCountInput) partCountInput.value = count;
              if (isEqualInput) isEqualInput.value = (type === 'equal');
              if (divisionTypeInput) divisionTypeInput.value = `${count}-${type}`;
            }

            if (!inputContainer || !widthInputsWrapper) return;
            inputContainer.innerHTML = '';
            widthInputsWrapper.style.display = 'block';

            const labels = (count === 2) ? ['راست', 'چپ'] : ['راست', 'وسط', 'چپ'];

            if (type === 'equal') {
              const base = Math.floor(total / count);
              const remainder = total - base * count;

              for (let i = 0; i < count; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = 'mb-2';

                const lbl = document.createElement('label');
                lbl.className = 'form-label';
                lbl.textContent = labels[i];

                const inp = document.createElement('input');
                inp.type = 'number';
                inp.readOnly = true;
                inp.className = 'form-control width-input';
                inp.name = `WidthParts[${i}]`;

                const extra = i < remainder ? 1 : 0;
                inp.value = base + extra;

                wrapper.appendChild(lbl);
                wrapper.appendChild(inp);
                inputContainer.appendChild(wrapper);
              }
            } else {
              for (let i = 0; i < count; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = 'mb-2';

                const lbl = document.createElement('label');
                lbl.className = 'form-label';
                lbl.textContent = labels[i];

                const inp = document.createElement('input');
                inp.type = 'number';
                inp.className = 'form-control width-input';
                inp.name = `WidthParts[${i}]`;
                inp.min = 1;
                inp.required = true;

                wrapper.appendChild(lbl);
                wrapper.appendChild(inp);
                inputContainer.appendChild(wrapper);
              }
            }

            validateForm();
          };

          // وقتی عرض تغییر می‌کند و تقسیم انتخاب شده مساوی است، مجدداً آپدیت کن
          if (widthInput) {
            widthInput.addEventListener('input', () => {
              const checked = form ? form.querySelector('input[name="division"]:checked') : null;
              if (!checked) return validateForm();

              const [cntStr, type] = checked.value.split('-');
              const count = Number(cntStr);

              if (type === 'equal') updateInputs(count, 'equal');
              else validateForm();
            });
          }

          if (inputContainer) inputContainer.addEventListener('input', () => validateForm());

          // modal reset — ایمن
          const modalEl = document.getElementById('customSizeModal');
          if (modalEl) {
            modalEl.addEventListener('shown.bs.modal', () => {
              if (form) form.reset();
              document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
              if (inputContainer) inputContainer.innerHTML = '';
              if (widthInputsWrapper) widthInputsWrapper.style.display = 'none';
              if (widthErrorEl) widthErrorEl.style.display = 'none';
              if (divisionErrorEl) divisionErrorEl.classList.add('d-none');
              if (adhesiveError) adhesiveError.classList.add('d-none');
              if (countErrorEl) countErrorEl.style.display = 'none';
              if (submitBtn) submitBtn.disabled = true;
            });
          }

          // submit و input handling
          if (form) {
            form.addEventListener('submit', e => {
              if (!validateForm()) {
                e.preventDefault();
                e.stopPropagation();
              }
            });

            form.addEventListener('input', validateForm);
          }

          // initial validation (اگر مودال باز نشد هم)
          validateForm();

>>>>>>> f99be209bd00a959536bd2503c41a4c308b467b4
        })();
    </script>
}
